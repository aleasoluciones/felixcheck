// Package gochecks provide a monitoring checks engine to create or embbed
// small monitoring system that can publish the periodic check result to
// other monitoring plataforms
package gochecks

import (
	"time"

	"github.com/aleasoluciones/goaleasoluciones/scheduledtask"
)

// Event is the check result
type Event struct {
	Host        string
	Service     string
	State       string
	Metric      interface{}
	Description string
	Tags        []string
	Attributes  map[string]string
	TTL         float32
}

type EventFilterFunction func(event Event) (bool, Event)

func NoopEventFilter(event Event) (bool, Event) {
	return true, event
}

// CheckEngine monitoring check engine to schedule periodics checks and publish
// the results
type CheckEngine struct {
	checkPublishers []CheckPublisher
	filterFunc      EventFilterFunction
	results         chan Event
}

// NewCheckEngine return a CheckEngine that publish the results of the
// periodic checks to the given publishers
func NewCheckEngine(publishers []CheckPublisher) *CheckEngine {
	checkEngine := CheckEngine{publishers, NoopEventFilter, make(chan Event)}
	go func() {
		for result := range checkEngine.results {
			ok, result := checkEngine.filterFunc(result)
			if ok {
				for _, publisher := range checkEngine.checkPublishers {
					publisher.PublishCheckResult(result)
				}
			}
		}
	}()
	return &checkEngine
}

func (ce *CheckEngine) SetFilter(f EventFilterFunction) {
	ce.filterFunc = f
}

// AddResult publish the given check result as if it was generated by a
// scheduled check
func (ce *CheckEngine) AddResult(event Event) {
	ce.results <- event
}

// AddCheck schedule a new check to be executed with the given period
func (ce *CheckEngine) AddCheck(check CheckFunction, period time.Duration) {
	scheduledtask.NewScheduledTask(func() {
		ce.results <- check()
	}, period, 0)
}

// AddMultiCheck schedule a new multi check to be executed with the given period
// the muli check can return an array of events/results
func (ce *CheckEngine) AddMultiCheck(check MultiCheckFunction, period time.Duration) {
	scheduledtask.NewScheduledTask(func() {
		for _, result := range check() {
			ce.results <- result
		}
	}, period, 0)
}
